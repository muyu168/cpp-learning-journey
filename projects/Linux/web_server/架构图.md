# WebServer æ¶æ„å›¾

## ä¸€ã€æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯æµè§ˆå™¨                              â”‚
â”‚                    (Chrome/Firefox/curl)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP è¯·æ±‚ (GET /index.html)
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    main.cpp (ä¸»çº¿ç¨‹)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ åˆå§‹åŒ–é˜¶æ®µï¼š                                                â”‚  â”‚
â”‚  â”‚   1. socket() -> bind() -> listen()                       â”‚  â”‚
â”‚  â”‚   2. epoll_create() åˆ›å»º epoll å¯¹è±¡                       â”‚  â”‚
â”‚  â”‚   3. threadpool<http_conn> åˆ›å»ºçº¿ç¨‹æ±                      â”‚  â”‚
â”‚  â”‚   4. http_conn users[MAX_FD] åˆ›å»ºè¿æ¥æ•°ç»„                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ äº‹ä»¶å¾ªç¯ (while(1)):                                      â”‚  â”‚
â”‚  â”‚   epoll_wait() ç­‰å¾…äº‹ä»¶                                    â”‚  â”‚
â”‚  â”‚   â”œâ”€ listenfd äº‹ä»¶ â†’ accept() â†’ users[connfd].init()     â”‚  â”‚
â”‚  â”‚   â”œâ”€ EPOLLIN äº‹ä»¶ â†’ read() â†’ pool->append()              â”‚  â”‚
â”‚  â”‚   â”œâ”€ EPOLLOUT äº‹ä»¶ â†’ write()                             â”‚  â”‚
â”‚  â”‚   â””â”€ EPOLLRDHUP/EPOLLERR â†’ close_conn()                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   threadpool     â”‚      â”‚   http_conn[]         â”‚
    â”‚   (å·¥ä½œçº¿ç¨‹æ± )     â”‚      â”‚   (è¿æ¥å¯¹è±¡æ•°ç»„)        â”‚
    â”‚                   â”‚      â”‚                      â”‚
    â”‚  worker çº¿ç¨‹ 1    â”‚â—„â”€â”€â”€â”€â”€â”¤  users[fd1]          â”‚
    â”‚  worker çº¿ç¨‹ 2    â”‚      â”‚    - m_sockfd        â”‚
    â”‚  worker çº¿ç¨‹ 3    â”‚      â”‚    - m_read_buf      â”‚
    â”‚  ...              â”‚      â”‚    - m_write_buf     â”‚
    â”‚  worker çº¿ç¨‹ N    â”‚      â”‚    - m_file_address â”‚
    â”‚                   â”‚      â”‚    ...              â”‚
    â”‚  ä»»åŠ¡é˜Ÿåˆ—:        â”‚      â”‚  users[fd2]          â”‚
    â”‚  [task1][task2]...â”‚      â”‚  users[fd3]          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  ...                â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€æ•°æ®æµå›¾ï¼ˆä¸€æ¬¡ HTTP è¯·æ±‚çš„å®Œæ•´æµç¨‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯      â”‚
â”‚  (æµè§ˆå™¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. å»ºç«‹ TCP è¿æ¥
       â”‚    connect()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»çº¿ç¨‹: epoll_wait() æ£€æµ‹åˆ° listenfd æœ‰äº‹ä»¶                  â”‚
â”‚   â”œâ”€ accept() æ¥å—è¿æ¥ï¼Œå¾—åˆ° connfd                          â”‚
â”‚   â”œâ”€ users[connfd].init(connfd, address)                    â”‚
â”‚   â”‚    â”œâ”€ è®¾ç½®éé˜»å¡                                        â”‚
â”‚   â”‚    â”œâ”€ addfd(epollfd, connfd, true) æ³¨å†Œåˆ° epoll        â”‚
â”‚   â”‚    â””â”€ åˆå§‹åŒ–çŠ¶æ€æœºçŠ¶æ€                                   â”‚
â”‚   â””â”€ è¿”å›äº‹ä»¶å¾ªç¯                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. å®¢æˆ·ç«¯å‘é€ HTTP è¯·æ±‚
       â”‚    GET /index.html HTTP/1.1\r\n
       â”‚    Host: localhost\r\n
       â”‚    Connection: keep-alive\r\n
       â”‚    \r\n
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»çº¿ç¨‹: epoll_wait() æ£€æµ‹åˆ° connfd æœ‰ EPOLLIN äº‹ä»¶          â”‚
â”‚   â”œâ”€ users[connfd].read()                                   â”‚
â”‚   â”‚    â”œâ”€ å¾ªç¯ recv() ç›´åˆ° EAGAIN                          â”‚
â”‚   â”‚    â””â”€ æ•°æ®å­˜å…¥ m_read_buf                              â”‚
â”‚   â”œâ”€ pool->append(users + connfd) åŠ å…¥çº¿ç¨‹æ± é˜Ÿåˆ—            â”‚
â”‚   â””â”€ è¿”å›äº‹ä»¶å¾ªç¯ï¼ˆç»§ç»­å¤„ç†å…¶ä»–äº‹ä»¶ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œçº¿ç¨‹: ä»é˜Ÿåˆ—å–å‡ºä»»åŠ¡                                     â”‚
â”‚   â””â”€ users[connfd].process()                                â”‚
â”‚        â”‚                                                    â”‚
â”‚        â”œâ”€â–º process_read()                                   â”‚
â”‚        â”‚     â”œâ”€ parse_line() è§£æä¸€è¡Œï¼ˆä»çŠ¶æ€æœºï¼‰            â”‚
â”‚        â”‚     â”œâ”€ parse_request_line()                        â”‚
â”‚        â”‚     â”‚    â”œâ”€ æå–æ–¹æ³•: GET                         â”‚
â”‚        â”‚     â”‚    â”œâ”€ æå– URL: /index.html                â”‚
â”‚        â”‚     â”‚    â””â”€ æå–ç‰ˆæœ¬: HTTP/1.1                    â”‚
â”‚        â”‚     â”œâ”€ parse_headers()                            â”‚
â”‚        â”‚     â”‚    â”œâ”€ Connection: keep-alive               â”‚
â”‚        â”‚     â”‚    â”œâ”€ Host: localhost                      â”‚
â”‚        â”‚     â”‚    â””â”€ Content-Length: 0                    â”‚
â”‚        â”‚     â””â”€ do_request()                              â”‚
â”‚        â”‚          â”œâ”€ æ‹¼æ¥è·¯å¾„: doc_root + m_url            â”‚
â”‚        â”‚          â”œâ”€ stat() æ£€æŸ¥æ–‡ä»¶                       â”‚
â”‚        â”‚          â””â”€ mmap() æ˜ å°„æ–‡ä»¶åˆ°å†…å­˜                  â”‚
â”‚        â”‚                                                    â”‚
â”‚        â””â”€â–º process_write()                                  â”‚
â”‚              â”œâ”€ add_status_line(200, "OK")                 â”‚
â”‚              â”œâ”€ add_headers(file_size)                     â”‚
â”‚              â”œâ”€ å‡†å¤‡ m_iv[0] = m_write_buf (å“åº”å¤´)        â”‚
â”‚              â””â”€ å‡†å¤‡ m_iv[1] = m_file_address (æ–‡ä»¶å†…å®¹)   â”‚
â”‚                                                    â”‚
â”‚        â””â”€ modfd(epollfd, connfd, EPOLLOUT) ä¿®æ”¹äº‹ä»¶        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»çº¿ç¨‹: epoll_wait() æ£€æµ‹åˆ° connfd æœ‰ EPOLLOUT äº‹ä»¶         â”‚
â”‚   â””â”€ users[connfd].write()                                  â”‚
â”‚        â”œâ”€ writev(connfd, m_iv, 2) åˆ†æ•£å†™                  â”‚
â”‚        â”‚    â”œâ”€ å‘é€å“åº”å¤´ (m_write_buf)                    â”‚
â”‚        â”‚    â””â”€ å‘é€æ–‡ä»¶å†…å®¹ (m_file_address)                â”‚
â”‚        â”œâ”€ å¦‚æœ EAGAINï¼Œç­‰å¾…ä¸‹æ¬¡ EPOLLOUT                   â”‚
â”‚        â”œâ”€ å‘é€å®Œæˆï¼Œunmap() é‡Šæ”¾å†…å­˜æ˜ å°„                    â”‚
â”‚        â””â”€ æ ¹æ® Connection å¤´å†³å®šæ˜¯å¦å…³é—­è¿æ¥               â”‚
â”‚             â”œâ”€ keep-alive: init() é‡ç½®çŠ¶æ€ï¼Œç»§ç»­ç›‘å¬        â”‚
â”‚             â””â”€ close: close_conn() å…³é—­è¿æ¥                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. HTTP å“åº”
       â”‚    HTTP/1.1 200 OK\r\n
       â”‚    Content-Length: xxx\r\n
       â”‚    Connection: keep-alive\r\n
       â”‚    \r\n
       â”‚    <html>...</html>
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯      â”‚
â”‚  (æµè§ˆå™¨)    â”‚
â”‚  æ˜¾ç¤ºé¡µé¢    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸‰ã€HTTP è§£æçŠ¶æ€æœº

### ä¸»çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHECK_STATE_REQUESTLINE â”‚  â† åˆå§‹çŠ¶æ€
â”‚   (è§£æè¯·æ±‚è¡Œ)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ parse_request_line() æˆåŠŸ
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHECK_STATE_HEADER       â”‚
â”‚   (è§£æè¯·æ±‚å¤´)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€ é‡åˆ°ç©ºè¡Œ (\r\n\r\n)
            â”‚  ä¸” Content-Length == 0
            â”‚  â†’ GET_REQUEST
            â”‚
            â””â”€ é‡åˆ°ç©ºè¡Œ
               ä¸” Content-Length > 0
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHECK_STATE_CONTENT      â”‚
â”‚   (è§£æè¯·æ±‚ä½“)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ parse_content() è¯»å–å®Œæ•´
            â–¼
      GET_REQUEST
         â”‚
         â–¼
    do_request()
    (å¤„ç†è¯·æ±‚)
```

### ä»çŠ¶æ€æœºï¼ˆè¡Œè§£æï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å§‹è§£æè¡Œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   æ£€æŸ¥å½“å‰å­—ç¬¦
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
  '\r'      '\n'
    â”‚         â”‚
    â”‚         â”‚ æ£€æŸ¥å‰ä¸€ä¸ªå­—ç¬¦æ˜¯å¦ä¸º '\r'
    â”‚         â”‚
    â”‚    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚    â”‚         â”‚
    â”‚    â–¼         â–¼
    â”‚  æ˜¯ '\r'   ä¸æ˜¯
    â”‚    â”‚         â”‚
    â”‚    â”‚         â–¼
    â”‚    â”‚    LINE_BAD
    â”‚    â”‚
    â”‚    â–¼
    â”‚ æ£€æŸ¥ä¸‹ä¸€ä¸ªå­—ç¬¦
    â”‚    â”‚
    â”‚    â”œâ”€ æ˜¯ '\n' â†’ LINE_OK
    â”‚    â””â”€ ä¸æ˜¯ â†’ LINE_BAD
    â”‚
    â–¼
æ£€æŸ¥æ˜¯å¦åˆ°ç¼“å†²åŒºæœ«å°¾
    â”‚
    â”œâ”€ æ˜¯ â†’ LINE_OPEN (ç»§ç»­è¯»å–)
    â””â”€ å¦ â†’ ç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªå­—ç¬¦
```

## å››ã€çº¿ç¨‹æ± å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸»çº¿ç¨‹ (main.cpp)                                        â”‚
â”‚                                                          â”‚
â”‚  users[connfd].read() è¯»å–æ•°æ®                          â”‚
â”‚         â”‚                                                â”‚
â”‚         â–¼                                                â”‚
â”‚  pool->append(users + connfd)                           â”‚
â”‚         â”‚                                                â”‚
â”‚         â”œâ”€â–º m_queuelocker.lock()                        â”‚
â”‚         â”œâ”€â–º m_workqueue.push_back(request)              â”‚
â”‚         â”œâ”€â–º m_queuelocker.unlock()                      â”‚
â”‚         â””â”€â–º m_queuestat.post() ä¿¡å·é‡ +1                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ä¿¡å·é‡å”¤é†’
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·¥ä½œçº¿ç¨‹ (worker thread)                                 â”‚
â”‚                                                          â”‚
â”‚  while(!m_stop) {                                       â”‚
â”‚      m_queuestat.wait() ç­‰å¾…ä¿¡å·é‡                       â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚      m_queuelocker.lock()                               â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚      if (m_workqueue.empty()) {                         â”‚
â”‚          unlock(); continue;                             â”‚
â”‚      }                                                   â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚      request = m_workqueue.front()                      â”‚
â”‚      m_workqueue.pop_front()                            â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚      m_queuelocker.unlock()                             â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚      request->process() å¤„ç†ä»»åŠ¡                         â”‚
â”‚           â”‚                                              â”‚
â”‚           â–¼                                              â”‚
â”‚      http_conn::process()                               â”‚
â”‚           â”œâ”€ process_read()                              â”‚
â”‚           â””â”€ process_write()                            â”‚
â”‚  }                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äº”ã€å†…å­˜å¸ƒå±€

### http_conn å¯¹è±¡å†…å­˜å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ http_conn users[MAX_FD]                 â”‚
â”‚                                         â”‚
â”‚ users[3]  â† connfd=3 çš„è¿æ¥            â”‚
â”‚   â”œâ”€ m_sockfd: 3                        â”‚
â”‚   â”œâ”€ m_read_buf[2048]                   â”‚
â”‚   â”‚   â””â”€ "GET /index.html HTTP/1.1..." â”‚
â”‚   â”œâ”€ m_write_buf[2048]                  â”‚
â”‚   â”‚   â””â”€ "HTTP/1.1 200 OK\r\n..."     â”‚
â”‚   â”œâ”€ m_file_address (mmap æ˜ å°„çš„åœ°å€)    â”‚
â”‚   â”‚   â””â”€ æŒ‡å‘æ–‡ä»¶å†…å®¹çš„å†…å­˜åœ°å€           â”‚
â”‚   â””â”€ m_iv[2] (writev çš„ iovec æ•°ç»„)     â”‚
â”‚       â”œâ”€ [0]: {m_write_buf, len1}       â”‚
â”‚       â””â”€ [1]: {m_file_address, len2}   â”‚
â”‚                                         â”‚
â”‚ users[4]  â† connfd=4 çš„è¿æ¥            â”‚
â”‚   â””â”€ ...                                â”‚
â”‚                                         â”‚
â”‚ users[5]  â† connfd=5 çš„è¿æ¥            â”‚
â”‚   â””â”€ ...                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–‡ä»¶æ˜ å°„ (mmap)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç£ç›˜æ–‡ä»¶: /resources/index.html         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ mmap() æ˜ å°„
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è™šæ‹Ÿå†…å­˜: m_file_address                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ <html>                            â”‚  â”‚
â”‚  â”‚   <head>...</head>                â”‚  â”‚
â”‚  â”‚   <body>...</body>                â”‚  â”‚
â”‚  â”‚ </html>                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ writev() ç›´æ¥å‘é€
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç½‘ç»œ: socket å‘é€ç¼“å†²åŒº                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…­ã€epoll äº‹ä»¶ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ epoll_event.events                      â”‚
â”‚                                         â”‚
â”‚ EPOLLIN   : å¯è¯»äº‹ä»¶                    â”‚
â”‚   â””â”€ å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œéœ€è¦è¯»å–            â”‚
â”‚                                         â”‚
â”‚ EPOLLOUT  : å¯å†™äº‹ä»¶                    â”‚
â”‚   â””â”€ socket å‘é€ç¼“å†²åŒºå¯å†™ï¼Œå¯ä»¥å‘é€æ•°æ®  â”‚
â”‚                                         â”‚
â”‚ EPOLLRDHUP: å¯¹ç«¯å…³é—­è¿æ¥ï¼ˆåŠå…³é—­ï¼‰       â”‚
â”‚   â””â”€ å®¢æˆ·ç«¯å…³é—­äº†å†™ç«¯                    â”‚
â”‚                                         â”‚
â”‚ EPOLLHUP  : æŒ‚èµ·äº‹ä»¶                    â”‚
â”‚   â””â”€ æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚èµ·                    â”‚
â”‚                                         â”‚
â”‚ EPOLLERR  : é”™è¯¯äº‹ä»¶                    â”‚
â”‚   â””â”€ å‘ç”Ÿé”™è¯¯                           â”‚
â”‚                                         â”‚
â”‚ EPOLLET   : è¾¹ç¼˜è§¦å‘æ¨¡å¼                â”‚
â”‚   â””â”€ åªåœ¨çŠ¶æ€å˜åŒ–æ—¶è§¦å‘ä¸€æ¬¡              â”‚
â”‚                                         â”‚
â”‚ EPOLLONESHOT: ä¸€æ¬¡æ€§äº‹ä»¶                â”‚
â”‚   â””â”€ äº‹ä»¶è§¦å‘åéœ€è¦é‡æ–°æ³¨å†Œ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸ƒã€å…³é”®æ•°æ®ç»“æ„

### http_conn ç±»å…³é”®æˆå‘˜

```cpp
class http_conn {
    // é™æ€æˆå‘˜ï¼ˆæ‰€æœ‰è¿æ¥å…±äº«ï¼‰
    static int m_epollfd;        // epoll æ–‡ä»¶æè¿°ç¬¦
    static int m_user_count;     // å½“å‰è¿æ¥æ•°
    
    // è¿æ¥ä¿¡æ¯
    int m_sockfd;                // socket æ–‡ä»¶æè¿°ç¬¦
    sockaddr_in m_address;        // å®¢æˆ·ç«¯åœ°å€
    
    // è¯»ç¼“å†²åŒº
    char m_read_buf[2048];       // è¯»ç¼“å†²åŒº
    int m_read_idx;              // å·²è¯»æ•°æ®é•¿åº¦
    int m_checked_index;         // å·²è§£æä½ç½®
    int m_start_line;            // å½“å‰è¡Œèµ·å§‹ä½ç½®
    
    // è§£æç»“æœ
    CHECK_STATE m_check_state;   // ä¸»çŠ¶æ€æœºçŠ¶æ€
    METHOD m_method;             // HTTP æ–¹æ³•
    char* m_url;                 // è¯·æ±‚ URL
    char* m_version;              // HTTP ç‰ˆæœ¬
    bool m_linger;               // æ˜¯å¦ä¿æŒè¿æ¥
    int m_content_length;        // è¯·æ±‚ä½“é•¿åº¦
    
    // æ–‡ä»¶ä¿¡æ¯
    char m_real_file[200];       // å®é™…æ–‡ä»¶è·¯å¾„
    char* m_file_address;        // mmap æ˜ å°„åœ°å€
    stat m_file_stat;            // æ–‡ä»¶çŠ¶æ€
    
    // å†™ç¼“å†²åŒº
    char m_write_buf[2048];      // å†™ç¼“å†²åŒº
    int m_write_idx;             // å¾…å‘é€æ•°æ®é•¿åº¦
    iovec m_iv[2];               // writev çš„ iovec æ•°ç»„
    int m_iv_count;              // iovec æ•°é‡
};
```

### threadpool ç±»å…³é”®æˆå‘˜

```cpp
template<typename T>
class threadpool {
    int m_thread_number;          // çº¿ç¨‹æ•°
    pthread_t* m_threads;        // çº¿ç¨‹æ•°ç»„
    int m_max_requests;           // æœ€å¤§è¯·æ±‚æ•°
    list<T*> m_workqueue;        // ä»»åŠ¡é˜Ÿåˆ—
    locker m_queuelocker;         // é˜Ÿåˆ—é”
    sem m_queuestat;             // ä¿¡å·é‡
    bool m_stop;                 // åœæ­¢æ ‡å¿—
};
```

---

## ğŸ“ å¦‚ä½•ä½¿ç”¨è¿™äº›å›¾

1. **ç†è§£é˜¶æ®µ**ï¼šå¯¹ç…§ä»£ç ï¼Œç†è§£æ¯ä¸ªæ¨¡å—çš„ä½œç”¨
2. **è®°å¿†é˜¶æ®µ**ï¼šä¸çœ‹ä»£ç ï¼Œåªçœ‹å›¾ï¼Œèƒ½å›å¿†èµ·æ•´ä¸ªæµç¨‹
3. **è®²è§£é˜¶æ®µ**ï¼šç”¨è¿™äº›å›¾å‘åˆ«äººè§£é‡Šé¡¹ç›®
4. **æ”¹è¿›é˜¶æ®µ**ï¼šåœ¨å›¾ä¸Šæ ‡æ³¨éœ€è¦æ”¹è¿›çš„åœ°æ–¹
